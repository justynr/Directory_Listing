const public_spreadsheet_url_suites = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTNik9F_6vPbPKCGneA6qMgExrkJhyl6MrzJhVj8PrK_T_EqqrFsgFJtPALhGkSw6mnX_nSuhknqZ0z/pub?gid=0&single=true&output=csv';
const public_spreadsheet_url_master = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTNik9F_6vPbPKCGneA6qMgExrkJhyl6MrzJhVj8PrK_T_EqqrFsgFJtPALhGkSw6mnX_nSuhknqZ0z/pub?gid=941655149&single=true&output=csv';
const public_spreadsheet_url = "http://docs.google.com/spreadsheets/d/e/2PACX-1vTNik9F_6vPbPKCGneA6qMgExrkJhyl6MrzJhVj8PrK_T_EqqrFsgFJtPALhGkSw6mnX_nSuhknqZ0z/pubhtml";

const suites = [
  {
    "suite": 0,
    "count": 0,
    "location": [
      -10,
      -10
    ]
  },
  {
    "suite": 1,
    "count": 0,
    "location": [
      240,
      580
    ],
    "categories": []
  },
  {
    "suite": 2,
    "count": 0,
    "location": [
      270,
      695
    ],
    "categories": []
  },
  {
    "suite": 3,
    "count": 0,
    "location": [
      310,
      580
    ],
    "categories": []
  },
  {
    "suite": 4,
    "count": 0,
    "location": [
      390,
      580
    ],
    "categories": []
  },
  {
    "suite": 5,
    "count": 0,
    "location": [
      350,
      695
    ],
    "categories": []
  },
  {
    "suite": 6,
    "count": 0,
    "location": [
      425,
      695
    ],
    "categories": []
  },
  {
    "suite": 7,
    "count": 0,
    "location": [
      490,
      665
    ],
    "categories": []
  },
  {
    "suite": 8,
    "count": 0,
    "location": [
      525,
      580
    ],
    "categories": []
  },
  {
    "suite": 9,
    "count": 0,
    "location": [
      555,
      510
    ],
    "categories": []
  },
  {
    "suite": 10,
    "count": 0,
    "location": [
      590,
      450
    ],
    "categories": []
  },
  {
    "suite": 11,
    "count": 0,
    "location": [
      620,
      390
    ],
    "categories": []
  },
  {
    "suite": 12,
    "count": 0,
    "location": [
      650,
      310
    ],
    "categories": []
  },
  {
    "suite": 13,
    "count": 0,
    "location": [
      520,
      320
    ],
    "categories": []
  },
  {
    "suite": 14,
    "count": 0,
    "location": [
      535,
      235
    ],
    "categories": []
  },
  {
    "suite": 15,
    "count": 0,
    "location": [
      650,
      250
    ],
    "categories": []
  },
  {
    "suite": 16,
    "count": 0,
    "location": [
      650,
      165
    ],
    "categories": []
  },
  {
    "suite": 17,
    "count": 0,
    "location": [
      535,
      165
    ],
    "categories": []
  },
  {
    "suite": 18,
    "count": 0,
    "location": [
      730,
      165
    ],
    "categories": []
  },
  {
    "suite": 19,
    "count": 0,
    "location": [
      770,
      60
    ],
    "categories": []
  },
  {
    "suite": 20,
    "count": 0,
    "location": [
      705,
      60
    ],
    "categories": []
  },
  {
    "suite": 21,
    "count": 0,
    "location": [
      620,
      60
    ],
    "categories": []
  },
  {
    "suite": 22,
    "count": 0,
    "location": [
      540,
      65
    ],
    "categories": []
  },
  {
    "suite": 23,
    "count": 0,
    "location": [
      460,
      60
    ],
    "categories": []
  },
  {
    "suite": 24,
    "count": 0,
    "location": [
      390,
      60
    ],
    "categories": []
  },
  {
    "suite": 25,
    "count": 0,
    "location": [
      320,
      60
    ],
    "categories": []
  },
  {
    "suite": 26,
    "count": 0,
    "location": [
      235,
      160
    ],
    "categories": []
  },
  {
    "suite": 27,
    "count": 0,
    "location": [
      40,
      60
    ],
    "categories": []
  },
  {
    "suite": 28,
    "count": 0,
    "location": [
      160,
      160
    ],
    "categories": []
  },
  {
    "suite": 29,
    "count": 0,
    "location": [
      40,
      145
    ],
    "categories": []
  },
  {
    "suite": 30,
    "count": 0,
    "location": [
      40,
      240
    ],
    "categories": []
  },
  {
    "suite": 31,
    "count": 0,
    "location": [
      160,
      235
    ],
    "categories": []
  },
  {
    "suite": 32,
    "count": 0,
    "location": [
      40,
      305
    ],
    "categories": []
  },
  {
    "suite": 33,
    "count": 0,
    "location": [
      160,
      315
    ],
    "categories": []
  },
  {
    "suite": 34,
    "count": 0,
    "location": [
      40,
      390
    ],
    "categories": []
  },
  {
    "suite": 35,
    "count": 0,
    "location": [
      40,
      465
    ],
    "categories": []
  },
  {
    "suite": 36,
    "count": 0,
    "location": [
      40,
      535
    ],
    "categories": []
  },
  {
    "suite": 37,
    "count": 0,
    "location": [
      160,
      580
    ],
    "categories": []
  },
  {
    "suite": 38,
    "count": 0,
    "location": [
      40,
      610
    ],
    "categories": []
  },
  {
    "suite": 39,
    "count": 0,
    "location": [
      40,
      690
    ],
    "categories": []
  },
  {
    "suite": 40,
    "count": 0,
    "location": [
      160,
      390
    ],
    "categories": []
  },
  {
    "suite": 41,
    "count": 0,
    "location": [
      160,
      510
    ],
    "categories": []
  },
  {
    "suite": 42,
    "count": 0,
    "location": [
      235,
      510
    ],
    "categories": []
  },
  {
    "suite": 43,
    "count": 0,
    "location": [
      235,
      390
    ],
    "categories": []
  },
  {
    "suite": 44,
    "count": 0,
    "location": [
      345,
      390
    ],
    "categories": []
  },
  {
    "suite": 45,
    "count": 0,
    "location": [
      305,
      510
    ],
    "categories": []
  },
  {
    "suite": 46,
    "count": 0,
    "location": [
      375,
      510
    ],
    "categories": []
  },
  {
    "suite": 47,
    "count": 0,
    "location": [
      445,
      515
    ],
    "categories": []
  },
  {
    "suite": 48,
    "count": 0,
    "location": [
      475,
      390
    ],
    "categories": []
  },
  {
    "suite": 49,
    "count": 0,
    "location": [
      460,
      320
    ],
    "categories": []
  },
  {
    "suite": 50,
    "count": 0,
    "location": [
      460,
      235
    ],
    "categories": []
  },
  {
    "suite": 51,
    "count": 0,
    "location": [
      460,
      165
    ],
    "categories": []
  }
]


const thisVersion = 3;


var data;
var masterData;

async function oldinit() {
  masterData = await doCORSRequest({
    method: 'GET',
    url: public_spreadsheet_url_master,
    data: ''
  }).then(function(jsonMasterData) {
    console.log(jsonMasterData)
    masterData = jsonMasterData
    return(jsonMasterData)
  }).then(doCORSRequest({
    method: 'GET',
    url: public_spreadsheet_url_suites,
    data: ''
  }).then(function(jsonSuiteData) {
    console.log(jsonSuiteData)
     parse(jsonSuiteData);
  }).catch(function(err) {
    console.error(`oh no! ${err}`)
  })
  );

  // masterData = await parseData(callBackThing);
  //data = await parseData(public_spreadsheet_url_suites);
  //await getMasterData();
  //await parse(data);
  //console.log(data)
  //await doHttpRequest();
}

let newSuiteData;
async function init() {
 masterData = await doCORSRequest({    
    method: 'GET',
    url: public_spreadsheet_url_master,
    data: ''
  })
  console.log(masterData)
newSuiteData = await doCORSRequest({
    method: 'GET',
    url: public_spreadsheet_url_suites,
    data: ''
  })
  console.log(newSuiteData)
parse(newSuiteData);

}

var suiteData;
var cors_api_url = 'https://cors-anywhere.herokuapp.com/';

function doCORSRequest(options) {
  return new Promise(function (resolve, reject) {
    var x = new XMLHttpRequest();
  x.open(options.method, cors_api_url + options.url);
  x.send(options.data);
  x.onload = function printResult() {
    suiteData = x.responseText
    const jsonData = Papa.parse(suiteData, {header: true} )
    console.log(jsonData.data)
    resolve(jsonData.data)
  };
  x.onerror = function () {reject()};
})
}

//CorsProxy(url)


const parseData = (file) => {
  return new Promise((resolve) => {
    Papa.parse(file, {
      download: true,
      header: true,
      complete: (results) => {
        //console.log(results);
        resolve(results.data);
      }
    });
  });
};


var masterCategory = [];

function parse(data) {
  console.log("I'm in the parse!", newSuiteData[1])
  console.log(masterData.length)
  ResizeCanvas();
  for (var i = 0; i < masterData.length; i++) {
    masterCategory.push(masterData[i].mastercategory);
    addCategory(i, masterData);
  };
  for (var i = 1; i < data.length; i++) {
    fillCategory(i);
  };
};

function fillCategory(i) {
  const { category, companyName, suite } = newSuiteData[i];
  const catList = category.replace(/\s/g,'').split(',');
  for (var j = 0; j < catList.length; j++) {
    if (masterCategory.includes(catList[j]) && suite < 52) {
    //Render Text
      const newDiv = document.createElement("p");
      newDiv.setAttribute('class', 'tenant');
      const text = document.createTextNode(`Suite ${suite} - ${companyName}`);
      newDiv.appendChild(text);
      const element = document.getElementById(`${catList[j]}List`);
      element.appendChild(newDiv);

      //Draw Dots
      const color = GetColor(catList[j]);
      AddressDraw(suite, color, catList[j]);
    }
  }
}

function addCategory(i) {
  const {mastercategory, mastercolor, column} = masterData[i]
 
  const elementTitle = document.getElementById(`column${column}`);
  const listDiv = document.createElement("div");
  const circleDiv = document.createElement("div");
  const titleDiv = document.createElement("div");

  listDiv.setAttribute('class', 'listing');
  circleDiv.setAttribute('class', 'circle');

  titleDiv.setAttribute('class', 'title');
  listDiv.setAttribute('id', `${mastercategory}List`)
  const text = document.createTextNode(mastercategory);
  titleDiv.appendChild(text);
  circleDiv.appendChild(titleDiv);
  listDiv.appendChild(circleDiv);
  elementTitle.appendChild(listDiv);
  circleDiv.style.backgroundColor = mastercolor;
}

function AddressDraw(i, color, category) {
  const existingCategories = suites[i].categories;
  if (!existingCategories.includes(category)) {
    const percent = getDotPercent(i);
    let dotX = percent[0];
    const dotY = percent[1];
    const count = suites[i].count;
    dotX += (count * percent[2])
    suites[i].count += 1;
    suites[i].categories.push(category);
    var c = document.getElementById("mapCanvas");
    var ctx = c.getContext("2d");
    ctx.beginPath();
    ctx.arc(dotX, dotY, percent[2], 0, 2 * Math.PI);
    ctx.fillStyle = color;
    ctx.fill();
  }
}

function getDotPercent(suite) {
  const image = document.getElementById("mapImage")
  let {height, width} = image;
  //console.log(suite)
  let dotX = suites[suite].location[0];
  let dotY = suites[suite].location[1];
  dotX = (width/840) * dotX;
  dotY = (height/769) * dotY;
  const dotSize = (width/840) * 10;
  //console.log(dotX, dotY, dotSize)
  return([Math.round(dotX), Math.round(dotY), Math.round(dotSize)])
}

function ResizeCanvas() {
  const canvas = document.getElementById("mapCanvas");
  // Lookup the size the browser is displaying the canvas.
  const image = document.getElementById("mapImage")

  var imageWidth = image.width;
  var imageHeight = image.height
  let {height, width} = image;
  var displayWidth  = canvas.clientWidth;
  var displayHeight = canvas.clientHeight;

  //console.log(displayWidth)
  //console.log(height, width)
 
  // Check if the canvas is not the same size.
  if (canvas.width  != displayWidth ||
      canvas.height != displayHeight) {
 
    // Make the canvas the same size
    canvas.width  = displayWidth;
    canvas.height = displayHeight;
  }
}

function GetColor(category) {
  const cat = masterData.find(el => el.mastercategory == category);
  const color = cat.mastercolor;
  return(color);
}




async function OlddoCORSRequest(options, printResult) {
  console.log("options", options)
  var x = new XMLHttpRequest();
  x.open(options.method, cors_api_url + options.url);
  x.onload = x.onerror = function printResult() {
    console.log(x.responseText)
    return(
      options.method + ' ' + options.url + '\n' +
      x.status + ' ' + x.statusText + '\n\n' +
      (x.responseText || '')
    );
  };
  if (/^POST/i.test(options.method)) {
    x.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  }
  x.send(options.data);
}
/*
(function() {
  var urlField = document.getElementById('url');
  var dataField = document.getElementById('data');
  var outputField = document.getElementById('output');
  function Anon() {
    e.preventDefault();
    doCORSRequest({
      method: 'GET',
      url: url
    }, function printResult(result) {
      outputField.value = result;
    });
  };
})();
if (typeof console === 'object') {
  console.log('// To test a local CORS Anywhere server, set cors_api_url. For example:');
  console.log('cors_api_url = "http://localhost:8080/"');
}
*/

// init();
window.addEventListener('DOMContentLoaded', init);
